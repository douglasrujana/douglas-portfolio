---
/**
 * Blog Post Page
 * Template para posts individuales con TOC, reading progress, etc.
 */

import { getEntry } from 'astro:content';
import { formatDate, getRelatedPosts, calculateReadingTime } from '@/lib/blog-utils';
import TechBadge from '@presentation/components/ui/TechBadge.svelte';
import PostCard from '@presentation/components/blog/PostCard.svelte';
import Footer from '@presentation/components/ui/Footer.svelte';
import { env } from '@infrastructure/config/env';

const { slug } = Astro.params;
const post = await getEntry('blog', slug as string);

// Si el post no se encuentra, redirigir a 404
if (!post) {
  return Astro.redirect('/404');
}

const { Content, headings } = await post.render();

// Calcular reading time si no está definido
const readingTime = post.data.readingTime || calculateReadingTime(post.body);

// Posts relacionados
const relatedPosts = await getRelatedPosts(post, 3);

// Metadata
const title = `${post.data.title} - Blog Douglas Rujana`;
const description = post.data.description;
const ogImage = post.data.ogImage || post.data.coverImage;

// Traducir categoría
const categoryLabels: Record<string, string> = {
  tutorial: 'Tutorial',
  'case-study': 'Caso de Estudio',
  opinion: 'Opinión',
  technical: 'Técnico',
  architecture: 'Arquitectura',
  ai: 'Inteligencia Artificial',
  devops: 'DevOps',
};
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="author" content={post.data.author} />
    
    <!-- Open Graph -->
    <meta property="og:title" content={post.data.title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="article" />
    <meta property="og:image" content={ogImage} />
    <meta property="article:published_time" content={post.data.publishedAt.toISOString()} />
    <meta property="article:author" content={post.data.author} />
    {post.data.tags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={post.data.title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={post.data.canonicalURL || `https://douglasrujana.com/blog/${post.slug}`} />
  </head>
  <body>
    <!-- Reading Progress Bar -->
    <div id="reading-progress" class="reading-progress"></div>

    <!-- Header -->
    <header class="post-header">
      <div class="container-jony">
        <nav class="post-nav">
          <a href="/blog" class="nav-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Volver al blog
          </a>
        </nav>
      </div>
    </header>

    <!-- Article -->
    <article class="post-article">
      <div class="container-jony">
        <div class="post-layout">
          <!-- Main Content -->
          <div class="post-main">
            <!-- Header -->
            <header class="article-header">
              <div class="article-meta">
                <span class="article-category">{categoryLabels[post.data.category]}</span>
                <span class="meta-separator">·</span>
                <time datetime={post.data.publishedAt.toISOString()}>
                  {formatDate(post.data.publishedAt)}
                </time>
                <span class="meta-separator">·</span>
                <span>{readingTime} min lectura</span>
              </div>

              <h1 class="article-title">{post.data.title}</h1>
              
              <p class="article-description">{post.data.description}</p>

              <!-- Tags -->
              <div class="article-tags">
                {post.data.tags.map(tag => (
                  <TechBadge label={tag} />
                ))}
              </div>

              <!-- Cover Image -->
              {post.data.coverImage && (
                <div class="article-cover">
                  <img 
                    src={post.data.coverImage} 
                    alt={post.data.coverImageAlt || post.data.title}
                    loading="lazy"
                  />
                </div>
              )}
            </header>

            <!-- Content -->
            <div class="article-content prose">
              <Content />
            </div>

            <!-- Footer -->
            <footer class="article-footer">
              <div class="article-author">
                <div class="author-info">
                  <strong>{post.data.author}</strong>
                  <time datetime={post.data.publishedAt.toISOString()}>
                    Publicado el {formatDate(post.data.publishedAt)}
                  </time>
                  {post.data.updatedAt && (
                    <time datetime={post.data.updatedAt.toISOString()}>
                      · Actualizado el {formatDate(post.data.updatedAt)}
                    </time>
                  )}
                </div>
              </div>

              <!-- Share buttons -->
              <div class="article-share">
                <span class="share-label">Compartir:</span>
                <a 
                  href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(`https://douglasrujana.com/blog/${post.slug}`)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="share-button"
                  aria-label="Compartir en Twitter"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"></path>
                  </svg>
                </a>
                <a 
                  href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(`https://douglasrujana.com/blog/${post.slug}`)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="share-button"
                  aria-label="Compartir en LinkedIn"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6zM2 9h4v12H2z"></path>
                    <circle cx="4" cy="4" r="2"></circle>
                  </svg>
                </a>
              </div>
            </footer>
          </div>

          <!-- Sidebar (TOC) -->
          {post.data.showToc && headings.length > 0 && (
            <aside class="post-sidebar">
              <div class="toc-wrapper">
                <h3 class="toc-title">Contenido</h3>
                <nav class="toc">
                  <ul class="toc-list">
                    {headings.map((heading) => (
                      <li class={`toc-item toc-level-${heading.depth}`}>
                        <a href={`#${heading.slug}`}>{heading.text}</a>
                      </li>
                    ))}
                  </ul>
                </nav>
              </div>
            </aside>
          )}
        </div>
      </div>
    </article>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="related-posts">
        <div class="container-jony">
          <h2 class="section-title">Artículos Relacionados</h2>
          <div class="related-grid">
            {relatedPosts.map(related => (
              <PostCard client:visible post={related} />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Footer -->
    <Footer 
      currentYear={new Date().getFullYear()}
      showTechCredits={false}
      socialLinks={{
        github: 'https://github.com/douglasrujana',
        linkedin: 'https://linkedin.com/in/douglasrujana',
        telegram: env.TELEGRAM_BOT_USERNAME ? `https://t.me/${env.TELEGRAM_BOT_USERNAME}` : null,
        whatsapp: env.WHATSAPP_NUMBER ? `https://wa.me/${env.WHATSAPP_NUMBER}?text=Hola%20Douglas,%20me%20encantó%20tu%20artículo` : null,
        email: 'tu@email.com'
      }}
    />

    <!-- Reading Progress Script -->
    <script>
      function updateReadingProgress() {
        const winScroll = document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        const progressBar = document.getElementById('reading-progress');
        if (progressBar) {
          progressBar.style.width = scrolled + '%';
        }
      }

      window.addEventListener('scroll', updateReadingProgress);
      window.addEventListener('resize', updateReadingProgress);
      updateReadingProgress();
    </script>
  </body>
</html>

<style is:global>
  @import '../../styles/jony-ive.css';

  /* Prose styles for markdown content */
  .prose {
    font-size: 1.0625rem;
    line-height: 1.8;
    color: var(--color-gray-800);
  }

  .prose h2,
  .prose h3,
  .prose h4 {
    font-weight: 400;
    color: var(--color-gray-900);
    margin-top: 2em;
    margin-bottom: 0.75em;
    scroll-margin-top: 100px;
  }

  .prose h2 { font-size: 1.875rem; }
  .prose h3 { font-size: 1.5rem; }
  .prose h4 { font-size: 1.25rem; }

  .prose p {
    margin-bottom: 1.5em;
  }

  .prose a {
    color: var(--color-accent);
    text-decoration: underline;
    text-decoration-color: rgba(0, 122, 255, 0.3);
    transition: text-decoration-color var(--transition-base);
  }

  .prose a:hover {
    text-decoration-color: var(--color-accent);
  }

  .prose code {
    font-family: var(--font-mono);
    font-size: 0.9em;
    padding: 0.2em 0.4em;
    background: var(--color-gray-100);
    border-radius: 4px;
  }

  .prose pre {
    padding: 1.5rem;
    background: var(--color-gray-900);
    color: var(--color-white);
    border-radius: var(--radius-md);
    overflow-x: auto;
    margin: 2em 0;
  }

  .prose pre code {
    background: none;
    padding: 0;
    color: inherit;
  }

  .prose ul, .prose ol {
    margin: 1.5em 0;
    padding-left: 1.5em;
  }

  .prose li {
    margin-bottom: 0.5em;
  }

  .prose blockquote {
    border-left: 4px solid var(--color-accent);
    padding-left: 1.5em;
    margin: 2em 0;
    font-style: italic;
    color: var(--color-gray-600);
  }

  .prose img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: 2em 0;
  }
</style>

<style>
  /* Reading Progress */
  .reading-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 3px;
    background: var(--color-accent);
    z-index: 1000;
    transition: width 0.1s ease-out;
  }

  /* Header */
  .post-header {
    padding: var(--space-lg) 0;
    border-bottom: 1px solid var(--color-gray-200);
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    z-index: 100;
  }

  .post-nav {
    display: flex;
    align-items: center;
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.9375rem;
    color: var(--color-gray-700);
    transition: color var(--transition-base);
  }

  .nav-link:hover {
    color: var(--color-gray-900);
  }

  /* Article */
  .post-article {
    padding: var(--space-2xl) 0;
  }

  .post-layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: var(--space-2xl);
    align-items: start;
  }

  /* Article Header */
  .article-header {
    margin-bottom: var(--space-2xl);
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.875rem;
    color: var(--color-gray-500);
    margin-bottom: var(--space-md);
  }

  .article-category {
    color: var(--color-accent);
    font-weight: 500;
  }

  .meta-separator {
    color: var(--color-gray-400);
  }

  .article-title {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 300;
    letter-spacing: -0.02em;
    line-height: 1.2;
    margin-bottom: var(--space-md);
  }

  .article-description {
    font-size: 1.25rem;
    font-weight: 300;
    color: var(--color-gray-600);
    line-height: 1.6;
    margin-bottom: var(--space-lg);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-bottom: var(--space-xl);
  }

  .article-cover {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-bottom: var(--space-xl);
  }

  .article-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Article Footer */
  .article-footer {
    margin-top: var(--space-2xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--color-gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-lg);
  }

  .author-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .author-info strong {
    font-weight: 500;
    color: var(--color-gray-900);
  }

  .author-info time {
    font-size: 0.875rem;
    color: var(--color-gray-500);
  }

  .article-share {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .share-label {
    font-size: 0.875rem;
    color: var(--color-gray-600);
  }

  .share-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    color: var(--color-gray-600);
    transition: all var(--transition-base);
  }

  .share-button:hover {
    background: var(--color-gray-100);
    color: var(--color-gray-900);
  }

  /* Sidebar (TOC) */
  .post-sidebar {
    position: sticky;
    top: calc(60px + var(--space-xl));
  }

  .toc-wrapper {
    background: var(--color-gray-50);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
  }

  .toc-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-gray-900);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-md);
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: var(--space-sm);
  }

  .toc-item a {
    font-size: 0.875rem;
    color: var(--color-gray-600);
    transition: color var(--transition-base);
    display: block;
    padding: var(--space-xs) 0;
  }

  .toc-item a:hover {
    color: var(--color-accent);
  }

  .toc-level-3 {
    padding-left: var(--space-md);
  }

  .toc-level-4 {
    padding-left: var(--space-lg);
  }

  /* Related Posts */
  .related-posts {
    padding: var(--space-2xl) 0;
    background: var(--color-gray-50);
  }

  .section-title {
    font-size: 2rem;
    font-weight: 300;
    text-align: center;
    margin-bottom: var(--space-xl);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-lg);
  }

  /* Footer */
  .footer {
    padding: var(--space-xl) 0;
    border-top: 1px solid var(--color-gray-200);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .post-layout {
      grid-template-columns: 1fr;
    }

    .post-sidebar {
      position: static;
      margin-top: var(--space-xl);
    }
  }

  @media (max-width: 768px) {
    .article-footer {
      flex-direction: column;
      align-items: flex-start;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }
  }
</style>